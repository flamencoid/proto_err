<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>proto_err.errorCount &mdash; proto_err 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="proto_err 0.0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../index.html">proto_err 0.0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for proto_err.errorCount</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pysam</span>
<span class="kn">from</span> <span class="nn">pysam</span> <span class="kn">import</span> <span class="n">AlignedRead</span>
<span class="kn">from</span> <span class="nn">fastaIO</span> <span class="kn">import</span> <span class="n">getRef</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">query</span> <span class="kn">import</span> <span class="n">errordb</span>
<span class="kn">from</span> <span class="nn">plot</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">error</span> <span class="kn">import</span> <span class="n">error</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span> <span class="k">as</span> <span class="n">listCounter</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>

<span class="kn">from</span> <span class="nn">rpy2.robjects.packages</span> <span class="kn">import</span> <span class="n">importr</span>
<span class="kn">from</span> <span class="nn">rpy2.robjects.vectors</span> <span class="kn">import</span> <span class="n">FloatVector</span>

<div class="viewcode-block" id="errorReader"><a class="viewcode-back" href="../../count.html#proto_err.errorCount.errorReader">[docs]</a><span class="k">class</span> <span class="nc">errorReader</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Iterable over errors in aligned reads</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    readCounter : dict</span>
<span class="sd">        A dictonary of counts of read alignment</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    samfile: string</span>
<span class="sd">        path to samfile</span>

<span class="sd">    ref: string</span>
<span class="sd">        reference sequence</span>


<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    error, counter</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from proto_err.errorCount import errorReader</span>
<span class="sd">    &gt;&gt;&gt; reader = errorReader(opt.samfile,ref)</span>
<span class="sd">    &gt;&gt;&gt; for error in reader:</span>
<span class="sd">    &gt;&gt;&gt;     print error</span>
<span class="sd">    SNP error(T to C)</span>
<span class="sd">    SNP error(A to T)</span>
<span class="sd">    Deletion error(CGCA to )</span>
<span class="sd">    ...</span>

<span class="sd">    &gt;&gt;&gt; print reader.readCounter</span>
<span class="sd">    {&#39;UnMapped&#39;: 454, &#39;mismatchedAlignments&#39;: 617, &#39;Total&#39;: 1225, &#39;perfectAlignments&#39;: 154, &#39;Mapped&#39;: 771}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samfile</span><span class="p">,</span><span class="n">ref</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__samfile</span> <span class="o">=</span> <span class="n">pysam</span><span class="o">.</span><span class="n">Samfile</span><span class="p">(</span> <span class="n">samfile</span> <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ref</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__alphabet</span> <span class="o">=</span> <span class="n">getAlphabet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;TotalReads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;UnMapped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;Mapped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;perfectAlignments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;mismatchedAlignments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;totalAlignedBases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;totalBases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;HardClippedReads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="s">&#39;MIDNSHP=X&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errorList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__refRead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the reference sequence the read is aligned to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">refRead</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ref</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="o">.</span><span class="n">positions</span><span class="p">]</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">refRead</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__readNext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterates to the next read in samfile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">## If there are errors left in the read </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__samfile</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;TotalReads&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;totalBases&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="o">.</span><span class="n">rlen</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="o">.</span><span class="n">is_unmapped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;UnMapped&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;Mapped&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;totalAlignedBases&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="o">.</span><span class="n">alen</span>
            <span class="k">if</span> <span class="s">&#39;H&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="o">.</span><span class="n">cigarstring</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;HardClippedReads&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__checkRead</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the next error in the samfile aligned read</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">## if the error list is empty get the next read</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__readNext</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># self.readCounter[&#39;totalErrorBases&#39;] = len(self.errorList)</span>

    <span class="k">def</span> <span class="nf">__checkRead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks current read for errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="s">&#39;NM&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;perfectAlignments&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;mismatchedAlignments&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__currentRefReadList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__refRead</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__currentReadList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="o">.</span><span class="n">seq</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__readPos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__readPosIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="o">.</span><span class="n">cigar</span><span class="p">:</span>
            <span class="n">cigarInt</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">numBases</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c">## Match or mismatch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkSNPs</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>                
                <span class="c">## Insertion to the reference</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkInsertion</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c">## Deletion from the reference</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkDeletion</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c">## skipped region from the reference</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkSkipped</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="c">##  soft clipping (clipped sequences present in SEQ)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkSoftClipped</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="c">##  hard clipping (clipped sequences NOT present in SEQ)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkHardClipped</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="c">## padding (silent deletion from padded reference)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkPadding</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                <span class="c">## sequence match</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkSeqMatch</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                <span class="c">## sequence mismatch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkSeqMismatch</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__currentRefReadList</span> <span class="o">==</span> <span class="p">[]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__currentReadList</span> <span class="o">==</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">__checkSNPs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks read segment for SNP errors. called when cigarstring = M:N </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;M&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">N</span>
        <span class="n">readSeg</span> <span class="o">=</span> <span class="n">popLong</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__currentReadList</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
        <span class="n">refSeg</span> <span class="o">=</span> <span class="n">popLong</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__currentRefReadList</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">readSeg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">refSeg</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">tupl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="n">refSeg</span><span class="p">,</span><span class="n">readSeg</span><span class="p">)):</span>
            <span class="n">true</span><span class="p">,</span><span class="n">emission</span> <span class="o">=</span> <span class="n">tupl</span>
            <span class="c">## if it&#39;s an error, check the preceding  opt.maxOrder bases</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">true</span> <span class="o">==</span> <span class="n">emission</span><span class="p">:</span>
                <span class="c">## Check preceding bases</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errorList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">true</span><span class="p">,</span><span class="n">emission</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="p">,</span><span class="n">readPos</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">__readPos</span><span class="p">,</span><span class="n">refPos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refPos</span><span class="o">+</span><span class="n">i</span><span class="p">))</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">__readPos</span> <span class="o">+=</span> <span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__readPosIndex</span> <span class="o">+=</span> <span class="n">N</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">refPos</span> <span class="o">+=</span> <span class="n">N</span>
    <span class="k">def</span> <span class="nf">__checkInsertion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks Insertion read segment for errors. called when cigarstring = I:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;I&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">N</span>
        <span class="n">insSeg</span> <span class="o">=</span> <span class="n">popLong</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__currentReadList</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errorList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">true</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insSeg</span><span class="p">),</span><span class="n">read</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="p">,</span><span class="n">readPos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__readPos</span><span class="p">,</span><span class="n">refPos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refPos</span><span class="p">))</span> <span class="c"># -1 as insertion occurs at previous base (if simulating)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__readPos</span> <span class="o">+=</span> <span class="n">N</span>

    <span class="k">def</span> <span class="nf">__checkDeletion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks Deletion read segment for  errors. called when cigarstring = D:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;D&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">N</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__readPosIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">j</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__readPosIndex</span><span class="p">]</span>        
        <span class="n">delSeg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ref</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errorList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">(</span><span class="n">true</span><span class="o">=</span><span class="n">delSeg</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">read</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="p">,</span><span class="n">readPos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__readPos</span><span class="p">,</span><span class="n">refPos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refPos</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refPos</span> <span class="o">+=</span> <span class="n">N</span>
        

    <span class="k">def</span> <span class="nf">__checkSkipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks skipped read segment for errors. called when cigarstring = N:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;N&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">N</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Haven&#39;t written a handler for this case yet&quot;</span><span class="p">)</span>
        <span class="mi">0</span><span class="o">/</span><span class="mi">0</span>
    <span class="k">def</span> <span class="nf">__checkSoftClipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks SoftClipped read segment for errors. called when cigarstring = S:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;S&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">N</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__currentReadList</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">N</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__checkHardClipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks HardClipped read segment for errors. called when cigarstring = H:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;H&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">N</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;We shouldn&#39;t have HardClipped bases in Samfile&quot;</span><span class="p">)</span>


        
    <span class="k">def</span> <span class="nf">__checkPadding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks Padding read segment for errors. called when cigarstring = P:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;P&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">N</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Haven&#39;t written a handler for this case yet&quot;</span><span class="p">)</span>
        <span class="mi">0</span><span class="o">/</span><span class="mi">0</span>
    <span class="k">def</span> <span class="nf">__checkSeqMismatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks SeqMismatch read segment for errors. called when cigarstring = =:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;=&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">N</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Haven&#39;t written a handler for this case yet&quot;</span><span class="p">)</span>
        <span class="mi">0</span><span class="o">/</span><span class="mi">0</span>
    <span class="k">def</span> <span class="nf">__checkSkipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks Skipped read segment for errors. called when cigarstring = X:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;X&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">N</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Haven&#39;t written a handler for this case yet&quot;</span><span class="p">)</span>
        <span class="mi">0</span><span class="o">/</span><span class="mi">0</span>




</div>
<span class="k">class</span> <span class="nc">counter</span><span class="p">():</span> 
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Takes a list of errors or samfile and does some kmer counting</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref : string</span>
<span class="sd">        The reference sequence</span>
<span class="sd">    errorList : list </span>
<span class="sd">        A list of error objects (Optional, can take samfile instead)</span>
<span class="sd">    samfile : string</span>
<span class="sd">        Path to samfile (Optional, can take a list of errors instead)</span>
<span class="sd">    opt : dict</span>
<span class="sd">        Options passed from OptionParser</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    errorList : list</span>
<span class="sd">        A list of error objects on which counting is done </span>
<span class="sd">    res : dict</span>
<span class="sd">        A dictonary containg resulting counts</span>
<span class="sd">    numErrors : int</span>
<span class="sd">        Number of errors in errorList</span>


<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    error, errorReader</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; errorCounter = counter(ref,samfile=opt.samfile)</span>
<span class="sd">    &gt;&gt;&gt; errorCounter.setup(opt)</span>
<span class="sd">    &gt;&gt;&gt; errorCounter.countRefKmer()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ref</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">errorList</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">samfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">makeDB</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>     <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samfile</span> <span class="o">=</span> <span class="n">samfile</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">errorList</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">samfile</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">errorList</span> <span class="ow">and</span> <span class="n">samfile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;counter takes errorList or samfile, at least one and not both&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">samfile</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">errorList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errorList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">errorReader</span><span class="p">(</span><span class="n">samfile</span><span class="p">,</span><span class="n">ref</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errorList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">readCounter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errorList</span> <span class="o">=</span> <span class="n">errorList</span>
        <span class="c"># the results dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;kmerCounts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AutoVivification</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;RefCounts&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">AutoVivification</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;errorMode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AutoVivification</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;qualCounter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AutoVivification</span><span class="p">()</span>
        <span class="c"># set toplevel name </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numErrors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errorList</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__countErrorKmerRun</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
        <span class="c">## Connection to mongoDB, runs without for now.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errordb</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">dbName</span><span class="p">,</span><span class="n">collection</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">observedErrorDBName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;simulatedErrors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errordb</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">dbName</span><span class="p">,</span><span class="n">collection</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">simulatedErrorDBName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;metaData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errordb</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">dbName</span><span class="p">,</span><span class="n">collection</span><span class="o">=</span><span class="s">&#39;metaData&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">makeDB</span><span class="p">:</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">deleteAll</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errorList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">addErrors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errorList</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;&quot;&quot;### Using pre-generated database.&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;&quot;&quot;### Initiate counter with makeDB=True to wipe and repopulate&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">qscoresCount</span> <span class="o">=</span> <span class="bp">None</span> <span class="c">## So we don&#39;t do counting twice</span>
        



    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">opt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pass options from OptionParser</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">opt</span>
        <span class="c">## Check that all required opts exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">maxKmerLength</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;opt.maxKmerLength not set, Defaulting to 3&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">maxKmerLength</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">__kmerFreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">seq</span><span class="p">,</span><span class="n">kmer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the number of times a kmer appears in a sequence</span>
<span class="sd">        seq : SeqRecord Object</span>
<span class="sd">        kmer : kmer string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">kmer</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">count</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">countRefKmer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">maxKmerLength</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count all kmers in the reference of length kmerLen or below</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        maxKmerLength : int</span>
<span class="sd">            This is a type.</span>
<span class="sd">            Maximum kmer length</span>


<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        dict</span>
<span class="sd">             dictonary of counts in the form</span>

<span class="sd">            {&#39;AAT&#39;:123,&#39;AA&#39;:123,...}</span>

<span class="sd">            emmissionDic[trueBase][emmitedBase] = count of trueBase -&gt; emmitedBase transition</span>

<span class="sd">            This also stored in the counter object in counter.res[&#39;RefCounts&#39;] </span>

<span class="sd">         See Also</span>
<span class="sd">        --------</span>
<span class="sd">        countErrorKmer</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">            &gt;&gt;&gt; from errorCount import counter</span>
<span class="sd">            &gt;&gt;&gt; errorCounter = counter(ref,samfile)</span>
<span class="sd">            &gt;&gt;&gt; errorCounter.countRefKmer(maxKmerLength = 3) </span>
<span class="sd">            &gt;&gt;&gt; ## counts all possible kmers of length 1,2,3 in reference</span>
<span class="sd">            &gt;&gt;&gt; {&#39;AAT&#39;:123,&#39;AA&#39;:123,...}</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">maxKmerLength</span><span class="p">:</span>
            <span class="n">maxKmerLength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">maxKmerLength</span>
        <span class="k">for</span> <span class="n">klen</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">maxKmerLength</span><span class="p">)]:</span>
            <span class="c"># generate all kmers of length klen</span>
            <span class="n">kmerList</span> <span class="o">=</span> <span class="n">kmerCombo</span><span class="p">(</span><span class="n">klen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;RefCounts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">kmerList</span><span class="p">,[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">kmerList</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">kmerList</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;RefCounts&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">kmer</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">kmer</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;RefCounts&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">countErrorKmer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">maxKmerLength</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count all kmers in the list of errors of length kmerLen or below before </span>
<span class="sd">        and after and error.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        maxKmerLength : int</span>
<span class="sd">            This is a type.</span>
<span class="sd">            Maximum kmer length</span>


<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        emmissionDic,beforeAfterCount</span>
<span class="sd">            dict,dict</span>
<span class="sd">            emmissionDic counts the number of times a transition occurs</span>

<span class="sd">            e.g. {&#39;A&#39;:{&#39;T&#39;:123,&#39;C&#39;:123,...,},&#39;T&#39;:{&#39;A&#39;:123,...},...}</span>

<span class="sd">            emmissionDic[trueBase][emmitedBase] = count of trueBase -&gt; emmitedBase transition</span>



<span class="sd">            beforeAfterCount counts the number of times a kmer appears before or after an error</span>

<span class="sd">            beforeAfterCount[&#39;before&#39;][trueBase][emmitedBase][kmer] = count of kmer occurance before trueBase -&gt; emmitedBase transition</span>

<span class="sd">            beforeAfterCount[&#39;after&#39;][trueBase][emmitedBase][kmer] = count of kmer occurance after trueBase -&gt; emmitedBase transition </span>



<span class="sd">            These dictonaries are also stored in the counter object in counter.res[&#39;errorMode&#39;],counter.res[&#39;kmerCounts&#39;]</span>

<span class="sd">         See Also</span>
<span class="sd">        --------</span>
<span class="sd">        countRefKmer</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">            &gt;&gt;&gt; from errorCount import counter</span>
<span class="sd">            &gt;&gt;&gt; errorCounter = counter(ref,samfile)</span>
<span class="sd">            &gt;&gt;&gt; errorCounter.countErrorKmer(maxKmerLength = 3) </span>
<span class="sd">            &gt;&gt;&gt; ## counts all possible kmers of length 1,2,3 before and after an error. </span>
<span class="sd">            &gt;&gt;&gt; ({&#39;A&#39;: {&#39;C&#39;: 113, &#39;T&#39;: 105, &#39;G&#39;: 84}, ...}, {&#39;after&#39;:{&#39;A&#39;: {&#39;C&#39;: {&#39;CTT&#39;: 2, &#39;GCA&#39;: 1,...},..}} ,&#39;before:{&#39;A&#39;: {&#39;C&#39;: {&#39;CTT&#39;: 2, &#39;GCA&#39;: 1,...},..}}&#39;})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__countErrorKmerRun</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">maxKmerLength</span><span class="p">:</span>
            <span class="n">maxKmerLength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">maxKmerLength</span>
        <span class="c"># </span>
        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorList</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;errorMode&#39;</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">true</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">emission</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;qualCounter&#39;</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">qual</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;errorMode&#39;</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">true</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">emission</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;qualCounter&#39;</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">qual</span><span class="p">]</span> <span class="o">=</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span> <span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">maxKmerLength</span><span class="p">)]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;kmerCounts&#39;</span><span class="p">][</span><span class="s">&#39;before&#39;</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">true</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">emission</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;kmerCounts&#39;</span><span class="p">][</span><span class="s">&#39;before&#39;</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">true</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">emission</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;kmerCounts&#39;</span><span class="p">][</span><span class="s">&#39;after&#39;</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">true</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">emission</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;kmerCounts&#39;</span><span class="p">][</span><span class="s">&#39;after&#39;</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">true</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">emission</span><span class="p">][</span><span class="n">error</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span><span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;errorMode&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;kmerCounts&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__readDiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">read</span><span class="p">,</span><span class="n">ref</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">difflib</span><span class="o">.</span><span class="n">ndiff</span><span class="p">(</span><span class="n">read</span><span class="p">,</span><span class="n">ref</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">countAlignedBases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the number of aligned bases in counter</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        int</span>
<span class="sd">            Count of aligned bases</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">            &gt;&gt;&gt; from errorCount import counter</span>
<span class="sd">            &gt;&gt;&gt; errorCounter = counter(ref,samfile)</span>
<span class="sd">            &gt;&gt;&gt; errorCounter.countAlignedBases() </span>
<span class="sd">            &gt;&gt;&gt; 12335</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorList</span><span class="p">:</span>
            <span class="n">read</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">read</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">read</span><span class="o">.</span><span class="n">cigar</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">count</span>
    <span class="k">def</span> <span class="nf">plotHist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots histograms</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        none : none</span>
<span class="sd">            no desc</span>


<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        outputs a png file to opt.imgDir</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">            &gt;&gt;&gt; from errorCount import counter</span>
<span class="sd">            &gt;&gt;&gt; errorCounter = counter(ref,samfile)</span>
<span class="sd">            &gt;&gt;&gt; errorCounter.plotHist()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># if not self.__countErrorKmerRun:</span>
        <span class="c">#     self.countErrorKmer()</span>
        <span class="c"># tmpDic =  self.res[&#39;errorMode&#39;]</span>
        <span class="n">observedDic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">expectedDic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">simulatedDic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">multi</span> <span class="o">=</span> <span class="n">AutoVivification</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">getAlphabet</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">getAlphabet</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">observed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="n">truth</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getExpectedCount</span><span class="p">(</span><span class="n">truth</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">simulated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSimulatedCount</span><span class="p">(</span><span class="n">truth</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">observedDic</span><span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="s">&#39;-&gt;&#39;</span> <span class="o">+</span> <span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">observed</span>
                    <span class="n">expectedDic</span><span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="s">&#39;-&gt;&#39;</span> <span class="o">+</span> <span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">expected</span>
                    <span class="n">simulatedDic</span><span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="s">&#39;-&gt;&#39;</span> <span class="o">+</span> <span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">simulated</span>
                    <span class="n">multi</span><span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="s">&#39;-&gt;&#39;</span> <span class="o">+</span> <span class="n">e</span><span class="p">][</span><span class="s">&#39;Expected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expected</span>
                    <span class="n">multi</span><span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="s">&#39;-&gt;&#39;</span> <span class="o">+</span> <span class="n">e</span><span class="p">][</span><span class="s">&#39;Observed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">observed</span>
                    <span class="n">multi</span><span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="s">&#39;-&gt;&#39;</span> <span class="o">+</span> <span class="n">e</span><span class="p">][</span><span class="s">&#39;Simulated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simulated</span>
        <span class="n">histPlotter</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="n">observedDic</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&quot;SNP_observed_transition&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="n">histPlotter</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="n">expectedDic</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&quot;SNP_expected_transition&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="n">histPlotter</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="n">simulatedDic</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&quot;SNP_simulated_transition&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="c"># multiHistPlotter(dic=multi,opt=self.opt,filename=&quot;SNP_observed_vs_expected_transition&quot;).plot()</span>
        <span class="n">multiHistPlotter</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="n">multi</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&quot;SNP_observed_simulated_expected_transition&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="c"># # Count deletion kmers</span>
        <span class="c"># # get maximum deletion length</span>
        <span class="n">observedSize</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;tlen&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="p">{</span><span class="s">&#39;type&#39;</span> <span class="p">:</span> <span class="s">&#39;Deletion&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;tlen&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span> <span class="p">)]</span>
        <span class="n">simulatedSize</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;tlen&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;simulatedErrors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="p">{</span><span class="s">&#39;type&#39;</span> <span class="p">:</span> <span class="s">&#39;Deletion&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;tlen&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span> <span class="p">)]</span>
        <span class="k">if</span> <span class="n">observedSize</span> <span class="ow">and</span> <span class="n">simulatedSize</span><span class="p">:</span>
            <span class="n">densityPlotterFromLists</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;observed&#39;</span><span class="p">:</span><span class="n">observedSize</span><span class="p">,</span><span class="s">&#39;simulated&#39;</span><span class="p">:</span><span class="n">simulatedSize</span><span class="p">},</span>
                                <span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&quot;deletion_size_hist_dens&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="s">&#39;dens&#39;</span><span class="p">)</span>
            <span class="n">densityPlotterFromLists</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;observed&#39;</span><span class="p">:</span><span class="n">observedSize</span><span class="p">,</span><span class="s">&#39;simulated&#39;</span><span class="p">:</span><span class="n">simulatedSize</span><span class="p">},</span>
                                <span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&quot;deletion_size_bar&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">)</span>

            <span class="n">maxLen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">observedSize</span> <span class="o">+</span> <span class="n">simulatedSize</span><span class="p">)</span> 
            <span class="c"># for order in [i+1 for i in range(maxLen)]:</span>
            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]:</span>
                <span class="n">dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__countToDic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;Deletion&#39;</span><span class="p">,</span><span class="n">tlenRange</span><span class="o">=</span><span class="n">order</span><span class="p">,</span><span class="n">returnList</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="n">attribute</span><span class="o">=</span><span class="s">&#39;true&#39;</span><span class="p">)</span>
                <span class="n">histPlotter</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="n">dic</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&quot;deletedKmerCount/deleted_kmer_observed_order_</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">order</span><span class="p">))</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
                <span class="n">dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__countToDic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSimulatedCount</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;Deletion&#39;</span><span class="p">,</span><span class="n">tlenRange</span><span class="o">=</span><span class="n">order</span><span class="p">,</span><span class="n">returnList</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="n">attribute</span><span class="o">=</span><span class="s">&#39;true&#39;</span><span class="p">)</span>
                <span class="n">histPlotter</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="n">dic</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&quot;deletedKmerCount/deleted_kmer_simulated_order_</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">order</span><span class="p">))</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="c">## Count insterted kmers </span>
        <span class="n">observedSize</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;tlen&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="p">{</span><span class="s">&#39;type&#39;</span> <span class="p">:</span> <span class="s">&#39;Insertion&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;tlen&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span> <span class="p">)]</span>
        <span class="n">simulatedSize</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;tlen&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;simulatedErrors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="p">{</span><span class="s">&#39;type&#39;</span> <span class="p">:</span> <span class="s">&#39;Insertion&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;tlen&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span> <span class="p">)]</span>
        <span class="k">if</span> <span class="n">observedSize</span> <span class="ow">and</span> <span class="n">simulatedSize</span><span class="p">:</span>
            <span class="n">densityPlotterFromLists</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;observed&#39;</span><span class="p">:</span><span class="n">observedSize</span><span class="p">,</span><span class="s">&#39;simulated&#39;</span><span class="p">:</span><span class="n">simulatedSize</span><span class="p">},</span>
                                <span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&quot;insertion_size_hist_dens&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="s">&#39;dens&#39;</span><span class="p">)</span>
            <span class="n">densityPlotterFromLists</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;observed&#39;</span><span class="p">:</span><span class="n">observedSize</span><span class="p">,</span><span class="s">&#39;simulated&#39;</span><span class="p">:</span><span class="n">simulatedSize</span><span class="p">},</span>
                                <span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&quot;insertion_size_bar&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">)</span>

            <span class="n">maxLen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">observedSize</span> <span class="o">+</span> <span class="n">simulatedSize</span><span class="p">)</span> 
            <span class="c"># for order in [i+1 for i in range(maxLen)]:</span>
            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]:</span>
                <span class="n">dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__countToDic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;Insertion&#39;</span><span class="p">,</span><span class="n">tlenRange</span><span class="o">=</span><span class="n">order</span><span class="p">,</span><span class="n">returnList</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="n">attribute</span><span class="o">=</span><span class="s">&#39;emmision&#39;</span><span class="p">)</span>
                <span class="n">histPlotter</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="n">dic</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&quot;insertedKmerCount/inserted_kmer_observed_order_</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">order</span><span class="p">))</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
                <span class="n">dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__countToDic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSimulatedCount</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;Insertion&#39;</span><span class="p">,</span><span class="n">tlenRange</span><span class="o">=</span><span class="n">order</span><span class="p">,</span><span class="n">returnList</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="n">attribute</span><span class="o">=</span><span class="s">&#39;emmision&#39;</span><span class="p">)</span>
                <span class="n">histPlotter</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="n">dic</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&quot;insertedKmerCount/inserted_kmer_simulated_order_</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">order</span><span class="p">))</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>


        <span class="c">## Count kmers      </span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">maxKmerLength</span><span class="p">)]:</span>
            <span class="n">dicBefore</span> <span class="o">=</span> <span class="n">AutoVivification</span><span class="p">()</span>
            <span class="n">dicAfter</span> <span class="o">=</span> <span class="n">AutoVivification</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">errorType</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">,</span><span class="s">&#39;Insertion&#39;</span><span class="p">,</span><span class="s">&#39;Deletion&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">kmerCombo</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">order</span><span class="p">):</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="n">kmerBefore</span> <span class="o">=</span> <span class="n">kmer</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="n">errorType</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
                        <span class="n">dicBefore</span><span class="p">[</span><span class="n">errorType</span><span class="p">][</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="n">kmerAfter</span> <span class="o">=</span> <span class="n">kmer</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="n">errorType</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dicAfter</span><span class="p">[</span><span class="n">errorType</span><span class="p">][</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span> 
                <span class="n">histPlotter</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="n">dicBefore</span><span class="p">[</span><span class="n">errorType</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&quot;kmerBeforeCount/kmer_before_</span><span class="si">%s</span><span class="s">_order_</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">errorType</span><span class="p">,</span><span class="n">order</span><span class="p">))</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
                <span class="n">histPlotter</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="n">dicBefore</span><span class="p">[</span><span class="n">errorType</span><span class="p">],</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&quot;kmerAfterCount/kmer_after_</span><span class="si">%s</span><span class="s">_order_</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">errorType</span><span class="p">,</span><span class="n">order</span><span class="p">))</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span> 

    <span class="k">def</span> <span class="nf">__countToDic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">errorList</span><span class="p">,</span><span class="n">attribute</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convience funciton to help with converting counts to dic for plotting</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        errorList : list</span>
<span class="sd">            list of error objects </span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        dic</span>
<span class="sd">            dictonary of counts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errorList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="s">&#39;true&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dic</span><span class="p">[</span><span class="n">error</span><span class="o">.</span><span class="n">true</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">dic</span><span class="p">[</span><span class="n">error</span><span class="o">.</span><span class="n">true</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">attribute</span> <span class="o">==</span> <span class="s">&#39;emmision&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dic</span><span class="p">[</span><span class="n">error</span><span class="o">.</span><span class="n">emission</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">dic</span><span class="p">[</span><span class="n">error</span><span class="o">.</span><span class="n">emission</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>                
        <span class="k">return</span> <span class="n">dic</span>

    <span class="k">def</span> <span class="nf">getFreqQual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">qual</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the frequency of a particular quality value in the samfile&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">qscoresCount</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Counting qual score frequency&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qscoresCount</span> <span class="o">=</span> <span class="n">listCounter</span><span class="p">([</span><span class="n">asciiToInt</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">read</span><span class="o">.</span><span class="n">qual</span> <span class="k">for</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">pysam</span><span class="o">.</span><span class="n">Samfile</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">samfile</span> <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">()))])</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qscoresCount</span><span class="p">[</span><span class="n">qual</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qscoresCount</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>



    <span class="k">def</span> <span class="nf">getExpectedCount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">truth</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">kmerBefore</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">kmerAfter</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">qual</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the expected count of a transition. </span>

<span class="sd">        E[true,emmision] = (frequency of truth in reference) * (Observed SNP Count) * (Probability of emmision | SNP ). </span>

<span class="sd">        i.e for a random reference E[true,emission] = 1/4 * numSnps * 1/3 </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        truth : string</span>
<span class="sd">            truth base(s)</span>
<span class="sd">        emission : string</span>
<span class="sd">            emmited base(s)</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        int</span>
<span class="sd">            Expected count</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">            &gt;&gt;&gt; from errorCount import counter</span>
<span class="sd">            &gt;&gt;&gt; errorCounter = counter(ref,samfile)</span>
<span class="sd">            &gt;&gt;&gt; print errorCounter.getExpectedCount(truth=&#39;A&#39;,emission=&#39;T&#39;)</span>
<span class="sd">            100.36</span>
<span class="sd">            &gt;&gt;&gt; print errorCounter.getCount(truth=&#39;A&#39;,emission=&#39;T&#39;)</span>
<span class="sd">            111</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simulationMetaData</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;metaData&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&#39;type&#39;</span><span class="p">:</span><span class="s">&#39;simulation&#39;</span><span class="p">},{</span><span class="s">&#39;snpFreq&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;readMean&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;numReads&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;SnpIndelRatio&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">qual</span><span class="p">:</span>
            <span class="n">pContext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probKmer</span><span class="p">(</span><span class="n">kmerBefore</span><span class="o">+</span><span class="n">truth</span><span class="o">+</span><span class="n">kmerAfter</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFreqQual</span><span class="p">(</span><span class="n">qual</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">truth</span><span class="p">:</span>
            <span class="n">pContext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probKmer</span><span class="p">(</span><span class="n">kmerBefore</span><span class="o">+</span><span class="n">truth</span><span class="o">+</span><span class="n">kmerAfter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pContext</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c"># print simulationMetaData</span>
        <span class="c"># ExpectedSNPCount = self.readCounter[&#39;totalAlignedBases&#39;] * simulationMetaData[&#39;snpFreq&#39;] * simulationMetaData[&#39;SnpIndelRatio&#39;] #snpFreq is actually the errorFrequencey</span>
        <span class="c"># ExpectedSNPCount = self.readCounter[&#39;totalBases&#39;] * simulationMetaData[&#39;snpFreq&#39;] * simulationMetaData[&#39;SnpIndelRatio&#39;] #snpFreq is actually the errorFrequencey</span>
        <span class="c"># probEmmission = float(1)/float(3)</span>
        <span class="k">if</span> <span class="n">qual</span><span class="p">:</span>
            <span class="n">probSNPError</span> <span class="o">=</span> <span class="n">qscoreToProb</span><span class="p">(</span><span class="n">qual</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">probSNPError</span> <span class="o">=</span> <span class="n">simulationMetaData</span><span class="p">[</span><span class="s">&#39;snpFreq&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">simulationMetaData</span><span class="p">[</span><span class="s">&#39;SnpIndelRatio&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">emission</span><span class="p">:</span>
            <span class="n">expectedCount</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;totalAlignedBases&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">pContext</span> <span class="o">*</span> <span class="n">probSNPError</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="c"># assume equal probabilites of eny transition</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expectedCount</span> <span class="o">=</span> <span class="n">pContext</span> <span class="o">*</span> <span class="n">probSNPError</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="p">[</span><span class="s">&#39;totalAlignedBases&#39;</span><span class="p">]</span>



        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">expectedCount</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">getSimulatedCount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">truth</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">kmerBefore</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">kmerAfter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">maxAlignedDist</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">readLength</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">readPosRange</span><span class="o">=</span><span class="p">[],</span><span class="n">readPerRange</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">qualRange</span><span class="o">=</span><span class="p">[],</span><span class="n">tlenRange</span><span class="o">=</span><span class="p">[],</span><span class="n">returnList</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the count of simulated errors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        truth : string</span>
<span class="sd">            truth base(s)</span>
<span class="sd">        emission : string</span>
<span class="sd">            emmited base(s)</span>
<span class="sd">        kmerBefore : string</span>
<span class="sd">            preceding kmer</span>
<span class="sd">        kmerAfter : string</span>
<span class="sd">            following kmer</span>
<span class="sd">        type : string</span>
<span class="sd">            type of error SNP Insertion or Deletion</span>
<span class="sd">        maxAlignedDist : int</span>
<span class="sd">            maximum aligned distance e.g. maxAlignedDist = 10 returns all errors where the read mapped within 10 bp of where it was sampled from </span>
<span class="sd">        readPosRange : list or tuple of ints</span>
<span class="sd">            list or tuple of two elements range of error position along read. e.g. [0,10] returns all errors in the first 10bp of read</span>
<span class="sd">        readPerRange : list or tuple of ints</span>
<span class="sd">            list or tuple of two elements range of error percentage along read. e.g. [0,10] returns all errors in the first 10percent of read</span>
<span class="sd">        qualRange : list or tuple of ints</span>
<span class="sd">            list or tuple of two elements range of quality of error e.g. [10,10] returns all errors with quality score 10</span>
<span class="sd">        returnList : bool</span>
<span class="sd">            default False. If true returns list of error documents as an additional argument</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        returnList = False int</span>
<span class="sd">            Count of errors matching Parameter query</span>
<span class="sd">        returnList = True int,list</span>
<span class="sd">            Count of errors matching Parameter query, list of error documents</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">            &gt;&gt;&gt; from errorCount import counter</span>
<span class="sd">            &gt;&gt;&gt; errorCounter = counter(ref,samfile)</span>
<span class="sd">            &gt;&gt;&gt; #### Count all the errors    </span>
<span class="sd">            &gt;&gt;&gt;print errorCounter.getSimulatedCount()</span>
<span class="sd">            1234</span>
<span class="sd">            &gt;&gt;&gt; ####   Count all the errors preceded by kmer &#39;A&#39;</span>
<span class="sd">            &gt;&gt;&gt; print errorCounter.getSimulatedCount(kmerBefore=&#39;AA&#39;)</span>
<span class="sd">            123</span>
<span class="sd">            &gt;&gt;&gt; ####  Count all the errors followed by kmer &#39;AA&#39;</span>
<span class="sd">            &gt;&gt;&gt; print errorCounter.getSimulatedCount(kmerAfter=&#39;AA&#39;)</span>
<span class="sd">            12</span>
<span class="sd">            &gt;&gt;&gt; ####     Count all the errors for truth &#39;A&#39; preceded by an A</span>
<span class="sd">            &gt;&gt;&gt; print errorCounter.getSimulatedCount(truth=&#39;A&#39;,kmerBefore&#39;A&#39;)</span>
<span class="sd">            123</span>
<span class="sd">            &gt;&gt;&gt; ####     Count all the errors A-&gt;T preceded by A</span>
<span class="sd">            &gt;&gt;&gt; print errorCounter.getSimulatedCount(truth=&#39;A&#39;,emission=&#39;T&#39;, kmerBefore=&#39;A&#39;)</span>
<span class="sd">            12</span>
<span class="sd">            &gt;&gt;&gt; ####  Count all the errors where the emmited base is &#39;A&#39; preceded by any kmer</span>
<span class="sd">            &gt;&gt;&gt; print errorCounter.getSimulatedCount(emission=&#39;A&#39;)</span>
<span class="sd">            2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="n">truth</span><span class="o">=</span><span class="n">truth</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="n">emission</span><span class="p">,</span><span class="n">kmerBefore</span><span class="o">=</span><span class="n">kmerBefore</span><span class="p">,</span>
                            <span class="n">kmerAfter</span><span class="o">=</span><span class="n">kmerAfter</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span><span class="n">maxAlignedDist</span><span class="o">=</span><span class="n">maxAlignedDist</span><span class="p">,</span>
                            <span class="n">readPosRange</span><span class="o">=</span><span class="n">readPosRange</span><span class="p">,</span><span class="n">readPerRange</span><span class="o">=</span><span class="n">readPerRange</span><span class="p">,</span>
                            <span class="n">qualRange</span><span class="o">=</span><span class="n">qualRange</span><span class="p">,</span><span class="n">tlenRange</span><span class="o">=</span><span class="n">tlenRange</span><span class="p">,</span><span class="n">readLength</span><span class="o">=</span><span class="n">readLength</span><span class="p">,</span><span class="n">returnList</span><span class="o">=</span><span class="n">returnList</span><span class="p">,</span>
                            <span class="n">collection</span><span class="o">=</span><span class="s">&#39;simulatedErrors&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">probKmer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">kmer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the fraction of </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kmer : string</span>
<span class="sd">            kmer to count</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        float</span>
<span class="sd">            freq in ref</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">kmer</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compareSimulationToResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">query</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">errorList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find_errors</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
        <span class="n">simErrorList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;simulatedErrors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find_errors</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
        <span class="n">errorDict</span>  <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">errorList</span><span class="p">:</span>
            <span class="n">errorDict</span><span class="p">[</span><span class="n">err</span><span class="o">.</span><span class="n">refPos</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span>
        <span class="n">simErrorDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">simErrorList</span><span class="p">:</span>
            <span class="n">simErrorDict</span><span class="p">[</span><span class="n">err</span><span class="o">.</span><span class="n">refPos</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span>

        <span class="n">TP</span> <span class="o">=</span> <span class="p">[]</span> <span class="c">## Corretly returned error</span>
        <span class="n">FP</span> <span class="o">=</span> <span class="p">[]</span> <span class="c">## Found but not in simulation</span>
        <span class="n">FN</span> <span class="o">=</span> <span class="p">[]</span> <span class="c">## In simulationg but not found</span>
        <span class="k">for</span> <span class="n">refPos</span><span class="p">,</span><span class="n">err</span> <span class="ow">in</span> <span class="n">errorDict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">refPos</span> <span class="ow">in</span> <span class="n">simErrorDict</span><span class="p">:</span>
                <span class="n">simErr</span> <span class="o">=</span> <span class="n">simErrorDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">refPos</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="n">simErr</span><span class="p">:</span>
                    <span class="n">TP</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">FP</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="n">FN</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">simErr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">FP</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="c">## All remaining sim errors are FN</span>
        <span class="n">FN</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">simErrorDict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">errorDic</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;TP&#39;</span><span class="p">:</span><span class="n">TP</span><span class="p">,</span><span class="s">&#39;FP&#39;</span><span class="p">:</span><span class="n">FP</span><span class="p">,</span><span class="s">&#39;FN&#39;</span><span class="p">:</span><span class="n">FN</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">errorDic</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Log a summary of errors found and samfile counts&quot;</span>

        <span class="c">## Initialise some pandas dataframes to sort output for writing to csv. </span>
        <span class="n">SNPRow</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;SNP&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">getSimulatedCount</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;SNP&#39;</span><span class="p">)]</span>
        <span class="n">INSRow</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;Insertion&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">getSimulatedCount</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;Insertion&#39;</span><span class="p">)]</span>
        <span class="n">DELRow</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;Deletion&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;Deletion&#39;</span><span class="p">)]</span>
        


        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Count of </span><span class="si">%s</span><span class="s"> in samfile = </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total SNP errors observed = </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SNPRow</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total SNP errors simulated = </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SNPRow</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total Insertion errors observed = </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">INSRow</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total Insertion errors simulated = </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">INSRow</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total Deletion errors observed = </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DELRow</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total Deletion errors simulated = </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DELRow</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c">## How many errors are from mismapped reads?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total errors from reads mapped mapped correctly =</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="n">mappedCorrectly</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total errors from mismapped reads =</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="n">mappedCorrectly</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Percentage of errors from  mismapped reads =</span><span class="si">%f</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="n">mappedCorrectly</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">())</span> <span class="p">),</span><span class="mi">2</span><span class="p">)))</span>

        <span class="c">## How many errors were correctly recovered?</span>

        <span class="c">## Download errors and simulated errors and generate two dicts of the form</span>
        <span class="c">## {redPos : errorObject}</span>
        <span class="n">compareDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compareSimulationToResults</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total simulated errors correctly found (TP) = </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;TP&#39;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total errors found which were not simulated (FP)= </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;FP&#39;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total errors simulated which were not found (FN)= </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;FN&#39;</span><span class="p">])))</span>
        <span class="n">compareDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compareSimulationToResults</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span><span class="s">&#39;SNP&#39;</span><span class="p">})</span>
        <span class="n">SNPRow</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;TP&#39;</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;FP&#39;</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;FN&#39;</span><span class="p">])</span> <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total simulated SNPs correctly found (TP) = </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;TP&#39;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total SNPs found which were not simulated (FP)= </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;FP&#39;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total SNPs simulated which were not found (FN)= </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;FN&#39;</span><span class="p">])))</span>
        <span class="n">compareDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compareSimulationToResults</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span><span class="s">&#39;Insertion&#39;</span><span class="p">})</span>
        <span class="n">INSRow</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;TP&#39;</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;FP&#39;</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;FN&#39;</span><span class="p">])</span> <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total simulated Insertions correctly found (TP) = </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;TP&#39;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total Insertions found which were not simulated (FP)= </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;FP&#39;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total Insertions simulated which were not found (FN)= </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;FN&#39;</span><span class="p">])))</span>
        <span class="n">compareDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compareSimulationToResults</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span><span class="s">&#39;Deletion&#39;</span><span class="p">})</span>
        <span class="n">DELRow</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;TP&#39;</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;FP&#39;</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;FN&#39;</span><span class="p">])</span> <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total simulated Deletions correctly found (TP) = </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;TP&#39;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total Deletions found which were not simulated (FP)= </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;FP&#39;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;### Total Deletions simulated which were not found (FN)= </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compareDict</span><span class="p">[</span><span class="s">&#39;FN&#39;</span><span class="p">])))</span>

        



        <span class="n">TotalRow</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SNPRow</span><span class="p">)):</span>
            <span class="n">TotalRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">SNPRow</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">INSRow</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">DELRow</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>

        <span class="n">SNPRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">SNPRow</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">SNPRow</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">SNPRow</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">INSRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">INSRow</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">INSRow</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">INSRow</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">DELRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">DELRow</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">DELRow</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">DELRow</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">TotalRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">TotalRow</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">TotalRow</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">TotalRow</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

        <span class="n">SNPRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">SNPRow</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">SNPRow</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">SNPRow</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
        <span class="n">INSRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">INSRow</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">INSRow</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">INSRow</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
        <span class="n">DELRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">DELRow</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">DELRow</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">DELRow</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
        <span class="n">TotalRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">TotalRow</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">TotalRow</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">TotalRow</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">outDir</span> <span class="o">+</span> <span class="s">&#39;errorsCount.dat&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Writing error counts to </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outfile</span><span class="p">))</span>
        <span class="n">errorsDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_items</span><span class="p">([(</span><span class="s">&#39;Total&#39;</span><span class="p">,</span> <span class="n">TotalRow</span><span class="p">),(</span><span class="s">&#39;SNP&#39;</span><span class="p">,</span> <span class="n">SNPRow</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;INS&#39;</span><span class="p">,</span> <span class="n">INSRow</span><span class="p">),(</span><span class="s">&#39;DEL&#39;</span><span class="p">,</span> <span class="n">DELRow</span><span class="p">)],</span>
                                <span class="n">orient</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;samCount&#39;</span><span class="p">,</span> <span class="s">&#39;simCount&#39;</span><span class="p">,</span> <span class="s">&#39;TP&#39;</span><span class="p">,</span><span class="s">&#39;FP&#39;</span><span class="p">,</span><span class="s">&#39;FN&#39;</span><span class="p">,</span><span class="s">&#39;Precision&#39;</span><span class="p">,</span><span class="s">&#39;Recall&#39;</span><span class="p">])</span>
        <span class="n">errorsDF</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_or_buf</span><span class="o">=</span><span class="n">outfile</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">outDir</span> <span class="o">+</span> <span class="s">&#39;readCounts.dat&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Writing read counts to </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outfile</span><span class="p">))</span>
        <span class="n">bases</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_items</span><span class="p">([(</span><span class="s">&#39;Counts&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="o">.</span><span class="n">values</span><span class="p">())],</span>
                                <span class="n">orient</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readCounter</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">bases</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_or_buf</span><span class="o">=</span><span class="n">outfile</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">SNPTransitionStats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        generate some statistics of transition probabilites</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Generating Context bias statistics&quot;</span><span class="p">)</span>
        <span class="n">alphabet</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;A&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;G&#39;</span><span class="p">]</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Generating unique list of quality scores&quot;</span><span class="p">)</span>
        <span class="n">qscores</span> <span class="o">=</span> <span class="n">unique</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;qual&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&#39;qual&#39;</span><span class="p">:{</span><span class="s">&#39;$exists&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="s">&#39;type&#39;</span><span class="p">:</span><span class="s">&#39;SNP&#39;</span> <span class="p">}</span> <span class="p">)])</span>
        <span class="n">outdic</span> <span class="o">=</span> <span class="n">AutoVivification</span><span class="p">()</span>
        <span class="n">outDicContextOnly</span> <span class="o">=</span> <span class="n">AutoVivification</span><span class="p">()</span>
        <span class="n">samCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">simCount</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="n">expectedCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">totalExpectedCount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getExpectedCount</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">before</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">truth</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">after</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="p">:</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="n">before</span> <span class="o">+</span> <span class="n">truth</span> <span class="o">+</span> <span class="n">after</span>
                    <span class="k">for</span> <span class="n">emission</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Context </span><span class="si">%s</span><span class="s"> aggregation&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
                        <span class="c">## Stats for contexts without q scores</span>
                        <span class="n">outDicContextOnly</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="s">&#39;samCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="n">truth</span><span class="o">=</span><span class="n">truth</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="n">emission</span><span class="p">,</span>
                                                                                <span class="n">kmerBefore</span><span class="o">=</span><span class="n">before</span><span class="p">,</span><span class="n">kmerAfter</span><span class="o">=</span><span class="n">after</span><span class="p">)</span>
                        <span class="n">outDicContextOnly</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="s">&#39;simCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSimulatedCount</span><span class="p">(</span><span class="n">truth</span><span class="o">=</span><span class="n">truth</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="n">emission</span><span class="p">,</span>
                                                                                <span class="n">kmerBefore</span><span class="o">=</span><span class="n">before</span><span class="p">,</span><span class="n">kmerAfter</span><span class="o">=</span><span class="n">after</span><span class="p">)</span>
                        <span class="n">outDicContextOnly</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="s">&#39;expectedCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getExpectedCount</span><span class="p">(</span><span class="n">truth</span><span class="o">=</span><span class="n">truth</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="n">emission</span><span class="p">,</span>
                                                                                <span class="n">kmerBefore</span><span class="o">=</span><span class="n">before</span><span class="p">,</span><span class="n">kmerAfter</span><span class="o">=</span><span class="n">after</span><span class="p">)</span>                           
                        <span class="n">outDicContextOnly</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="s">&#39;pvalue&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">binom_test</span><span class="p">(</span><span class="n">outDicContextOnly</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="s">&#39;samCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">],</span> <span class="n">totalExpectedCount</span><span class="p">,</span> <span class="n">outDicContextOnly</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="s">&#39;expectedCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span><span class="o">/</span><span class="n">totalExpectedCount</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">outDicContextOnly</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="s">&#39;samCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">outDicContextOnly</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="s">&#39;expectedDiff&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span> <span class="n">outDicContextOnly</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="s">&#39;samCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">outDicContextOnly</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="s">&#39;expectedCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]))</span> <span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                        <span class="c">## Stats for contexts with q scores</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">truth</span> <span class="o">==</span> <span class="n">emission</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">qscore</span> <span class="ow">in</span> <span class="n">qscores</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Context </span><span class="si">%s</span><span class="s"> quality score </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">qscore</span><span class="p">))</span>
                                <span class="n">outdic</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">qscore</span><span class="p">][</span><span class="s">&#39;samCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="n">truth</span><span class="o">=</span><span class="n">truth</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="n">emission</span><span class="p">,</span>
                                                                                <span class="n">kmerBefore</span><span class="o">=</span><span class="n">before</span><span class="p">,</span><span class="n">kmerAfter</span><span class="o">=</span><span class="n">after</span><span class="p">,</span><span class="n">qualRange</span><span class="o">=</span><span class="p">[</span><span class="n">qscore</span><span class="p">,</span><span class="n">qscore</span><span class="p">])</span>
                                <span class="n">outdic</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">qscore</span><span class="p">][</span><span class="s">&#39;simCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSimulatedCount</span><span class="p">(</span><span class="n">truth</span><span class="o">=</span><span class="n">truth</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="n">emission</span><span class="p">,</span>
                                                                                <span class="n">kmerBefore</span><span class="o">=</span><span class="n">before</span><span class="p">,</span><span class="n">kmerAfter</span><span class="o">=</span><span class="n">after</span><span class="p">,</span><span class="n">qualRange</span><span class="o">=</span><span class="p">[</span><span class="n">qscore</span><span class="p">,</span><span class="n">qscore</span><span class="p">])</span>
                                <span class="n">outdic</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">qscore</span><span class="p">][</span><span class="s">&#39;expectedCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getExpectedCount</span><span class="p">(</span><span class="n">truth</span><span class="o">=</span><span class="n">truth</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="n">emission</span><span class="p">,</span>
                                                                                <span class="n">kmerBefore</span><span class="o">=</span><span class="n">before</span><span class="p">,</span><span class="n">kmerAfter</span><span class="o">=</span><span class="n">after</span><span class="p">,</span><span class="n">qual</span><span class="o">=</span><span class="n">qscore</span><span class="p">)</span>
                                <span class="n">outdic</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">qscore</span><span class="p">][</span><span class="s">&#39;pvalue&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">binom_test</span><span class="p">(</span><span class="n">outdic</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">qscore</span><span class="p">][</span><span class="s">&#39;samCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">],</span> <span class="n">totalExpectedCount</span><span class="p">,</span> <span class="n">outdic</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">qscore</span><span class="p">][</span><span class="s">&#39;expectedCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span><span class="o">/</span><span class="n">totalExpectedCount</span><span class="p">)</span> <span class="p">)</span>
                                
                                <span class="n">samCount</span> <span class="o">+=</span>  <span class="n">outdic</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">qscore</span><span class="p">][</span><span class="s">&#39;samCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span>
                                <span class="n">simCount</span> <span class="o">+=</span> <span class="n">outdic</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">qscore</span><span class="p">][</span><span class="s">&#39;simCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span>
                                <span class="n">expectedCount</span> <span class="o">+=</span> <span class="n">outdic</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">qscore</span><span class="p">][</span><span class="s">&#39;expectedCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">outdic</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">qscore</span><span class="p">][</span><span class="s">&#39;samCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">outdic</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">qscore</span><span class="p">][</span><span class="s">&#39;expectedDiff&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span> <span class="n">outdic</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">qscore</span><span class="p">][</span><span class="s">&#39;samCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">outdic</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">qscore</span><span class="p">][</span><span class="s">&#39;expectedCount&#39;</span><span class="p">][</span><span class="n">emission</span><span class="p">]))</span> <span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="c"># pprint (outdic)</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">outDicContextOnly</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">samCount</span><span class="p">,</span><span class="n">simCount</span><span class="p">,</span><span class="n">expectedCount</span>
        <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCount</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;SNP&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">getSimulatedCount</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;SNP&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">getExpectedCount</span><span class="p">()</span>

        <span class="c">## Create friendly output</span>

        <span class="c">##                      simCount     ExptCount   SamCount    pvalue  pvalue-corrected</span>
        <span class="c">## Context ContextOut</span>
        <span class="c">## AAA  ATC 123 122     124 0.05    0.2</span>
        <span class="c">## ...</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Generating readable output&quot;</span><span class="p">)</span>
        <span class="n">outputList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">outputWithQscoresList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">before</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">truth</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">after</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">emission</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">truth</span> <span class="o">==</span> <span class="n">emission</span><span class="p">:</span>
                            <span class="n">context</span> <span class="o">=</span> <span class="n">before</span> <span class="o">+</span> <span class="n">truth</span> <span class="o">+</span> <span class="n">after</span>
                            <span class="n">contextOut</span> <span class="o">=</span> <span class="n">before</span> <span class="o">+</span> <span class="n">emission</span> <span class="o">+</span> <span class="n">after</span>
                            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">context</span><span class="p">,</span><span class="n">contextOut</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">outDicContextOnly</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;simCount&#39;</span><span class="p">,</span><span class="s">&#39;samCount&#39;</span><span class="p">,</span><span class="s">&#39;expectedCount&#39;</span><span class="p">,</span><span class="s">&#39;pvalue&#39;</span><span class="p">]]</span>
                            <span class="n">outputList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">qscore</span> <span class="ow">in</span> <span class="n">qscores</span><span class="p">:</span>
                                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">context</span><span class="p">,</span><span class="n">contextOut</span><span class="p">,</span><span class="n">qscore</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">outdic</span><span class="p">[</span><span class="s">&#39;SNP&#39;</span><span class="p">][</span><span class="n">context</span><span class="p">][</span><span class="n">qscore</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="n">emission</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;simCount&#39;</span><span class="p">,</span><span class="s">&#39;samCount&#39;</span><span class="p">,</span><span class="s">&#39;expectedCount&#39;</span><span class="p">,</span><span class="s">&#39;pvalue&#39;</span><span class="p">]]</span>
                                <span class="n">outputWithQscoresList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">outputList</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;ContextTrue&#39;</span><span class="p">,</span><span class="s">&#39;ContextEmit&#39;</span><span class="p">,</span><span class="s">&#39;simCount&#39;</span><span class="p">,</span><span class="s">&#39;samCount&#39;</span><span class="p">,</span><span class="s">&#39;expectedCount&#39;</span><span class="p">,</span><span class="s">&#39;pvalue&#39;</span><span class="p">])</span>
        <span class="n">dfQ</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">outputWithQscoresList</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;ContextTrue&#39;</span><span class="p">,</span><span class="s">&#39;ContextEmit&#39;</span><span class="p">,</span><span class="s">&#39;qscore&#39;</span><span class="p">,</span><span class="s">&#39;simCount&#39;</span><span class="p">,</span><span class="s">&#39;samCount&#39;</span><span class="p">,</span><span class="s">&#39;expectedCount&#39;</span><span class="p">,</span><span class="s">&#39;pvalue&#39;</span><span class="p">])</span>

        <span class="c">## Adjust the p-values for multiple testing</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s">&#39;stats&#39;</span><span class="p">)</span>
        <span class="n">p_adjust</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">p_adjust</span><span class="p">(</span><span class="n">FloatVector</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;pvalue&#39;</span><span class="p">])),</span> <span class="n">method</span> <span class="o">=</span> <span class="s">&#39;BH&#39;</span><span class="p">)</span>
        <span class="n">p_adjustQ</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">p_adjust</span><span class="p">(</span><span class="n">FloatVector</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dfQ</span><span class="p">[</span><span class="s">&#39;pvalue&#39;</span><span class="p">])),</span> <span class="n">method</span> <span class="o">=</span> <span class="s">&#39;BH&#39;</span><span class="p">)</span>
        
        <span class="n">df</span><span class="p">[</span><span class="s">&#39;pvalue-adjust&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_adjust</span>
        <span class="n">dfQ</span><span class="p">[</span><span class="s">&#39;pvalue-adjust&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_adjustQ</span>



        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s">&#39;pvalue&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dfQ</span> <span class="o">=</span> <span class="n">dfQ</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s">&#39;pvalue&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">outDir</span> <span class="o">+</span> <span class="s">&#39;contextStats.dat&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Writing context bias stats to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outfile</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_or_buf</span><span class="o">=</span><span class="n">outfile</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span> 

        
        <span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">outDir</span> <span class="o">+</span> <span class="s">&#39;contextQualityScoreStats.dat&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Writing context and qual score bias stats to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outfile</span><span class="p">))</span>
        <span class="n">dfQ</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_or_buf</span><span class="o">=</span><span class="n">outfile</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span> 

                        
    









    <span class="k">def</span> <span class="nf">getCount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">truth</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">emission</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">kmerBefore</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">kmerAfter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">maxAlignedDist</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">mappedCorrectly</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">readLength</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">readPosRange</span><span class="o">=</span><span class="p">[],</span><span class="n">readPerRange</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">qualRange</span><span class="o">=</span><span class="p">[],</span><span class="n">tlenRange</span><span class="o">=</span><span class="p">[],</span><span class="n">returnList</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">collection</span><span class="o">=</span><span class="s">&#39;errors&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the count for a given {truth,emmision,kmer}</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        truth : string</span>
<span class="sd">            truth base(s)</span>
<span class="sd">        emission : string</span>
<span class="sd">            emmited base(s)</span>
<span class="sd">        kmerBefore : string</span>
<span class="sd">            preceding kmer</span>
<span class="sd">        kmerAfter : string</span>
<span class="sd">            following kmer</span>
<span class="sd">        type : string</span>
<span class="sd">            type of error SNP Insertion or Deletion</span>
<span class="sd">        maxAlignedDist : int</span>
<span class="sd">            maximum aligned distance e.g. maxAlignedDist = 10 returns all errors where the read mapped within 10 bp of where it was sampled from </span>
<span class="sd">        mappedCorrectly : bool</span>
<span class="sd">            Mapped distance within read length</span>
<span class="sd">        readPosRange : list or tuple of ints</span>
<span class="sd">            list or tuple of two elements range of error position along read. e.g. [0,10] returns all errors in the first 10bp of read</span>
<span class="sd">        readPerRange : list or tuple of ints</span>
<span class="sd">            list or tuple of two elements range of error percentage along read. e.g. [0,10] returns all errors in the first 10percent of read</span>
<span class="sd">        qualRange : list or tuple of ints</span>
<span class="sd">            list or tuple of two elements range of quality of error e.g. [10,10] returns all errors with quality score 10</span>
<span class="sd">        tlenRange : int or list or tuple</span>
<span class="sd">            int list or tuple of two elements range of quality of error e.g. [10,10] returns all errors with quality score 10 equivalent to 10</span>
<span class="sd">        returnList : bool</span>
<span class="sd">            default False. If true returns list of error documents as an additional argument</span>


<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        returnList = False int</span>
<span class="sd">            Count of errors matching Parameter query</span>
<span class="sd">        returnList = True int,list</span>
<span class="sd">            Count of errors matching Parameter query, list of error documents</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">            &gt;&gt;&gt; from errorCount import counter</span>
<span class="sd">            &gt;&gt;&gt; errorCounter = counter(ref,samfile)</span>
<span class="sd">            &gt;&gt;&gt; #### Count all the errors    </span>
<span class="sd">            &gt;&gt;&gt;print errorCounter.getCount()</span>
<span class="sd">            1234</span>
<span class="sd">            &gt;&gt;&gt; ####   Count all the errors preceded by kmer &#39;A&#39;</span>
<span class="sd">            &gt;&gt;&gt; print errorCounter.getCount(kmerBefore=&#39;AA&#39;)</span>
<span class="sd">            123</span>
<span class="sd">            &gt;&gt;&gt; ####  Count all the errors followed by kmer &#39;AA&#39;</span>
<span class="sd">            &gt;&gt;&gt; print errorCounter.getCount(kmerAfter=&#39;AA&#39;)</span>
<span class="sd">            12</span>
<span class="sd">            &gt;&gt;&gt; ####     Count all the errors for truth &#39;A&#39; preceded by an A</span>
<span class="sd">            &gt;&gt;&gt; print errorCounter.getCount(truth=&#39;A&#39;,kmerBefore&#39;A&#39;)</span>
<span class="sd">            123</span>
<span class="sd">            &gt;&gt;&gt; ####     Count all the errors A-&gt;T preceded by A</span>
<span class="sd">            &gt;&gt;&gt; print errorCounter.getCount(truth=&#39;A&#39;,emission=&#39;T&#39;, kmerBefore=&#39;A&#39;)</span>
<span class="sd">            12</span>
<span class="sd">            &gt;&gt;&gt; ####  Count all the errors where the emmited base is &#39;A&#39; preceded by any kmer</span>
<span class="sd">            &gt;&gt;&gt; print errorCounter.getCount(emission=&#39;A&#39;)</span>
<span class="sd">            2</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c">########### Monogo DB Verison</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">truth</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s">&#39;true&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">truth</span>
        <span class="k">if</span> <span class="n">emission</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s">&#39;emission&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">emission</span>
        <span class="k">if</span> <span class="n">kmerBefore</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s">&#39;leftFlank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;$regex&#39;</span><span class="p">:</span><span class="n">kmerBefore</span><span class="o">+</span><span class="s">&#39;$&#39;</span><span class="p">,</span><span class="s">&#39;$options&#39;</span><span class="p">:</span> <span class="s">&#39;i&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">kmerAfter</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s">&#39;rightFlank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;$regex&#39;</span><span class="p">:</span><span class="s">&#39;^&#39;</span><span class="o">+</span><span class="n">kmerAfter</span><span class="p">,</span> <span class="s">&#39;$options&#39;</span><span class="p">:</span> <span class="s">&#39;i&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="k">if</span> <span class="n">maxAlignedDist</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s">&#39;alignedDist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;$lte&#39;</span><span class="p">:</span><span class="n">maxAlignedDist</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">mappedCorrectly</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s">&#39;mappedCorrectly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mappedCorrectly</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">readPosRange</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s">&#39;readPos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;$lte&#39;</span><span class="p">:</span><span class="n">readPosRange</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;$gte&#39;</span><span class="p">:</span><span class="n">readPosRange</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="k">if</span> <span class="n">readPerRange</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s">&#39;readPer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;$lte&#39;</span><span class="p">:</span><span class="n">readPerRange</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;$gte&#39;</span><span class="p">:</span><span class="n">readPerRange</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="k">if</span> <span class="n">readLength</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s">&#39;readLength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">readLength</span>
        <span class="k">if</span> <span class="n">qualRange</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s">&#39;qual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;$lte&#39;</span><span class="p">:</span><span class="n">qualRange</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;$gte&#39;</span><span class="p">:</span><span class="n">qualRange</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="k">if</span> <span class="n">tlenRange</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tlenRange</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="n">tlenRange</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="n">query</span><span class="p">[</span><span class="s">&#39;tlen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;$lte&#39;</span><span class="p">:</span><span class="n">tlenRange</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;$gte&#39;</span><span class="p">:</span><span class="n">tlenRange</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span><span class="p">[</span><span class="s">&#39;tlen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tlenRange</span>
        
        <span class="n">mongoPointer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">returnList</span><span class="p">:</span>
            <span class="n">errorList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span><span class="o">.</span><span class="n">find_errors</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mongoPointer</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span><span class="n">errorList</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mongoPointer</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">db_summary</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">opt</span><span class="p">):</span>
        <span class="c">## Connection to mongoDB, runs without for now.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errordb</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">dbName</span><span class="p">,</span><span class="n">collection</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">observedErrorDBName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;simulatedErrors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errordb</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">dbName</span><span class="p">,</span><span class="n">collection</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">simulatedErrorDBName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;metaData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errordb</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">dbName</span><span class="p">,</span><span class="n">collection</span><span class="o">=</span><span class="s">&#39;metaData&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">opt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qscores</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errorQualList</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">getAllQualScores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns a list of quality scores of all the bases&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Extracting Qscores from samfile&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">asciiToInt</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">read</span><span class="o">.</span><span class="n">qual</span> <span class="k">for</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">pysam</span><span class="o">.</span><span class="n">Samfile</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">samfile</span> <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">()))]</span>

    <span class="k">def</span> <span class="nf">errorDistribution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ed</span> <span class="o">=</span>  <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s">&#39;readPer&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="p">{},</span><span class="n">filt</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;readPer&#39;</span><span class="p">})]</span>
        <span class="k">if</span> <span class="n">ed</span><span class="p">:</span>
            <span class="n">densityPlotterFromLists</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;errorDistribution&#39;</span><span class="p">:</span><span class="n">ed</span><span class="p">},</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;errorDistribution_dens&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
            <span class="n">densityPlotterFromLists</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;errorDistribution&#39;</span><span class="p">:</span><span class="n">ed</span><span class="p">},</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;errorDistribution_hist&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="s">&#39;hist&#39;</span><span class="p">)</span>

        <span class="n">simEd</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s">&#39;readPer&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;simulatedErrors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="p">{},</span><span class="n">filt</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;readPer&#39;</span><span class="p">})]</span>
        <span class="k">if</span> <span class="n">simEd</span><span class="p">:</span>
            <span class="n">densityPlotterFromLists</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;errorDistribution&#39;</span><span class="p">:</span><span class="n">simEd</span><span class="p">},</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;simulatedErrorDistribution_dens&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
            <span class="n">densityPlotterFromLists</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;errorDistribution&#39;</span><span class="p">:</span><span class="n">simEd</span><span class="p">},</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;simulatedErrorDistribution_hist&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="s">&#39;hist&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">errorQualDistribution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorQualList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errorQualList</span> <span class="o">=</span>  <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s">&#39;qual&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;type&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&#39;$ne&#39;</span><span class="p">:</span> <span class="s">&#39;Deletion&#39;</span><span class="p">}},</span><span class="n">filt</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;qual&#39;</span><span class="p">})]</span>
        <span class="k">if</span> <span class="n">ed</span><span class="p">:</span>
            <span class="n">densityPlotterFromLists</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;errorQualDistribution&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">errorQualList</span><span class="p">},</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;errorQualDistribution_dens&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
            <span class="n">densityPlotterFromLists</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;errorQualDistribution&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">errorQualList</span><span class="p">},</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;errorQualDistribution_hist&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="s">&#39;hist&#39;</span><span class="p">)</span>

        <span class="n">simEd</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s">&#39;qual&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;simulatedErrors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="p">{},</span><span class="n">filt</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;qual&#39;</span><span class="p">})]</span>
        <span class="k">if</span> <span class="n">simEd</span><span class="p">:</span>
            <span class="n">densityPlotterFromLists</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;simulatederrorQualDistribution&#39;</span><span class="p">:</span><span class="n">simEd</span><span class="p">},</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;simulatederrorQualDistribution_dens&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
            <span class="n">densityPlotterFromLists</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;simulatederrorQualDistribution&#39;</span><span class="p">:</span><span class="n">simEd</span><span class="p">},</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;simulatederrorQualDistribution_hist&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="s">&#39;hist&#39;</span><span class="p">)</span>        

    <span class="k">def</span> <span class="nf">qualDistribution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">qscores</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qscores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAllQualScores</span><span class="p">()</span>

        <span class="n">densityPlotterFromLists</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;QualDistribution&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">qscores</span><span class="p">},</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;QualDistribution_dens&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="n">densityPlotterFromLists</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;QualDistribution&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">qscores</span><span class="p">},</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;QualDistribution_hist&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="s">&#39;hist&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">qScoreCalibrationTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;plots assigned qscore versus emperical qscore to assess how well calibrated the quals are&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Assess qscore calibration&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">qscores</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qscores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAllQualScores</span><span class="p">()</span>
        <span class="n">qScoreCounts</span> <span class="o">=</span> <span class="n">listCounter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qscores</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorQualList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errorQualList</span> <span class="o">=</span>  <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s">&#39;qual&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;type&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&#39;$ne&#39;</span><span class="p">:</span> <span class="s">&#39;Deletion&#39;</span><span class="p">}},</span><span class="n">filt</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;qual&#39;</span><span class="p">})]</span>
        <span class="n">errorQscoreCounts</span> <span class="o">=</span> <span class="n">listCounter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errorQualList</span><span class="p">)</span>
        <span class="n">empiricalQscore</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">samQscore</span> <span class="o">=</span>  <span class="p">[</span><span class="n">qual</span> <span class="k">for</span> <span class="n">qual</span><span class="p">,</span><span class="n">count</span> <span class="ow">in</span> <span class="n">qScoreCounts</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">qual</span> <span class="ow">in</span> <span class="n">samQscore</span><span class="p">:</span>
            <span class="n">empiricalQscore</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">probToQscore</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">errorQscoreCounts</span><span class="p">[</span><span class="n">qual</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">qScoreCounts</span><span class="p">[</span><span class="n">qual</span><span class="p">])))</span>
        <span class="n">scatterPloter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">samQscore</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">empiricalQscore</span><span class="p">,</span>
                    <span class="n">xlab</span><span class="o">=</span><span class="s">&#39;known&#39;</span><span class="p">,</span><span class="n">ylab</span><span class="o">=</span><span class="s">&#39;empirical&#39;</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="s">&#39;qscoreCalibration&#39;</span><span class="p">,</span><span class="n">opt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

    <span class="nd">@property</span> 
    <span class="k">def</span> <span class="nf">numErrors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Get the number of errors in the database&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">errordb</span><span class="p">[</span><span class="s">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>



<span class="k">class</span> <span class="nc">samReader</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Read the same file and return human readable alignments&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">samfile</span><span class="p">,</span><span class="n">ref</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samfile</span> <span class="o">=</span> <span class="n">pysam</span><span class="o">.</span><span class="n">Samfile</span><span class="p">(</span> <span class="n">samfile</span> <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the next read in the samfile aligned read</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alignedRead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samfile</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignedRead</span><span class="o">.</span><span class="n">is_unmapped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getReadID</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__parseRead</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">getReadID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alignedRead</span><span class="o">.</span><span class="n">qname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;id=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__parseRead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        parses the read and returns readable alignment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentRead</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentRefRead</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__currentRefReadList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__refRead</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__currentReadList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alignedRead</span><span class="o">.</span><span class="n">seq</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__readPos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__readPosIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignedRead</span><span class="o">.</span><span class="n">cigar</span><span class="p">:</span>
            <span class="n">cigarInt</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">numBases</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c">## Match or mismatch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkSNPs</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>                
                <span class="c">## Insertion to the reference</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkInsertion</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c">## Deletion from the reference</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkDeletion</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c">## skipped region from the reference</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkSkipped</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="c">##  soft clipping (clipped sequences present in SEQ)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkSoftClipped</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="c">##  hard clipping (clipped sequences NOT present in SEQ)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkHardClipped</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="c">## padding (silent deletion from padded reference)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkPadding</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                <span class="c">## sequence match</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkSeqMatch</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cigarInt</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                <span class="c">## sequence mismatch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkSeqMismatch</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">numBases</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentRefRead</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentRead</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__refRead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the reference sequence the read is aligned to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">refRead</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignedRead</span><span class="o">.</span><span class="n">positions</span><span class="p">]</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">refRead</span><span class="p">)</span>
    

    <span class="k">def</span> <span class="nf">__checkSNPs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks read segment for SNP errors. called when cigarstring = M:N </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">readSeg</span> <span class="o">=</span> <span class="n">popLong</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__currentReadList</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
        <span class="n">refSeg</span> <span class="o">=</span> <span class="n">popLong</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__currentRefReadList</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">currentRead</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">readSeg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentRefRead</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">refSeg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__readPos</span> <span class="o">+=</span> <span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__readPosIndex</span> <span class="o">+=</span> <span class="n">N</span>  
    <span class="k">def</span> <span class="nf">__checkInsertion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks Insertion read segment for errors. called when cigarstring = I:N </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c">## add _ to reference</span>
        <span class="n">insSeg</span> <span class="o">=</span> <span class="n">popLong</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__currentReadList</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentRead</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">insSeg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentRefRead</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">insSeg</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__readPos</span> <span class="o">+=</span> <span class="n">N</span>
    <span class="k">def</span> <span class="nf">__checkDeletion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks Deletion read segment for  errors. called when cigarstring = D:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">## add _ to read</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignedRead</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__readPosIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">j</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">alignedRead</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__readPosIndex</span><span class="p">]</span>        
        <span class="n">delSeg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentRead</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">delSeg</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentRefRead</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">delSeg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__checkSkipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks skipped read segment for errors. called when cigarstring = N:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Haven&#39;t written a handler for this case yet&quot;</span><span class="p">)</span>
        <span class="mi">0</span><span class="o">/</span><span class="mi">0</span>
    <span class="k">def</span> <span class="nf">__checkSoftClipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks SoftClipped read segment for errors. called when cigarstring = S:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clippedSeg</span> <span class="o">=</span> <span class="n">popLong</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__currentReadList</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentRead</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">clippedSeg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentRefRead</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">clippedSeg</span><span class="p">))</span>

        
    <span class="k">def</span> <span class="nf">__checkHardClipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks HardClipped read segment for errors. called when cigarstring = H:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;We shouldn&#39;t have HardClipped bases in Samfile&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__checkPadding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks Padding read segment for errors. called when cigarstring = P:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Haven&#39;t written a handler for this case yet&quot;</span><span class="p">)</span>
        <span class="mi">0</span><span class="o">/</span><span class="mi">0</span>
    <span class="k">def</span> <span class="nf">__checkSeqMismatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks SeqMismatch read segment for errors. called when cigarstring = =:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Haven&#39;t written a handler for this case yet&quot;</span><span class="p">)</span>
        <span class="mi">0</span><span class="o">/</span><span class="mi">0</span>
    <span class="k">def</span> <span class="nf">__checkSkipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks Skipped read segment for errors. called when cigarstring = X:N </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Haven&#39;t written a handler for this case yet&quot;</span><span class="p">)</span>
        <span class="mi">0</span><span class="o">/</span><span class="mi">0</span>       

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentRead</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">refRead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentRefRead</span><span class="p">)</span> 
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../index.html">proto_err 0.0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Phelim Bradley.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b3.
    </div>
  </body>
</html>